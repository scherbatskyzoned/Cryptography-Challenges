from pwn import *
import hashpumpy
from binascii import unhexlify, hexlify


HOST = '130.192.5.212' 
PORT = 6630

server = remote(HOST, PORT)


# Copied from server (get a real one by interacting with it)
username = b"alice"

server.sendlineafter(b"Choose an option (1-3): ", b"1") # Get a coupon
server.sendlineafter(b"Enter your name: ", username)

server.recvline()
original_coupon_hex = server.recvline().strip().split()[-1]
original_mac_hex = server.recvline().strip().split()[-1]

print("Original coupon:", original_coupon_hex)
print("Original MAC:   ", original_mac_hex)

# Decode coupon properly 
original_coupon = unhexlify(original_coupon_hex)
extension = b"&value=100000"

# Perform the length extension
key_len = 16
new_mac, new_msg = hashpumpy.hashpump(original_mac_hex, original_coupon, extension, key_len)

# Print results to feed to server
forged_coupon_hex = hexlify(new_msg).decode()

server.sendlineafter(b"Choose an option (1-3): ", b"2") # Buy
server.sendlineafter(b"Enter your coupon: ", forged_coupon_hex.encode())
server.sendlineafter(b"Enter your MAC: ", new_mac.encode())
print(server.recv(1024))